# GetTransactionIndex Precompile method


|RSKIP          | 1 |
| :------------ |:-------------|
|**Title**      |GetTransactionIndex Precompile method|
|**Created**    |NOV-2020 |
|**Author**     |SDL |
|**Purpose**    |Sec |
|**Layer**      |Core |
|**Complexity** |1 |
|**Status**     |Draft |


# **Abstract**


A useful functionality in contracts is to link events, so that dApps and wallets can collect all events generated by a contract by querying the contract about the last block number it changed state and doing it recursively at each given block number. However, if the contract changfes state several times within a block (being called from different transactions in the same block), then this technique cannot provide inter-block pointers not a full node is able to query the world state between transactions. The solution is to log in the receipt tree the block number and transaction index of the previous state change. 
RSK has an opcode TXINDEX that pushes into the stack the index of the current transaction in the block, and therefore RSK can easily link events. However Solidity does not support this opcode natively and therefore the RSK community decided to deprecate this opcode. To keep the same functionality, we propose to add to the BlockHeaders precompiled contract a method to obtain the transaction index.

## Motivation

When the Powpeg federation composition changes, a new federation address is activated and the old one is disposed. Light clients and wallets must always query a trusted RSK node to obtain the latest federation address. Several methods can be used to reduce the extent of this trust. One is that the node provides certain amount of cumulative proof of work starting from the logged event that the Bridge generates when a new federation address is activated. However, a fixed amount of work does not guarantee that the federation address is the last. 
Another protection that can be useful for a wallet is to request from a full node a chain of federation migration transactions, starting with a known address embedded in the wallet source code. However, without the identification of at least one migration transaction, it's impossible for the wallet to distinguish between a peg-out without a change output and a migration transaction. This RSKIP proposes the use of an additional Bitcoin transaction output with an OP_RETURN opcode and a magic word to mark migrations. The wallet should only use the last address of the migration chain. 

## Specification

The first transaction of a federation migration process must have, as the last output, an OP_RETURN followed by the push of 6 bytes with ASCII content "RSKMIG".

## Rationale

There exists other alternatives to the proposed change, such as requiring that the old federation signs a different message containing only the new federation address. This results in a smaller chains in terms of space. However it requires changing the Powpeg node, the Btidge and PowHSM firmware, while this proposal only requires changing the Bridge code.

## Backwards Compatibility

This is a hard-forking change, but it doesn't affect smart contracts, dApps, federation nodes or PowHSMs.

## Test Cases

TBD

## Implementation

TBA

## Security Considerations

While a dumb wallet cannot validate if the last address of a given chain is actually the active address, the incentive to fool the wallet into using an old address is low, because to profit from it the attacker would need to be in control of the majority of private keys of such old federation address to steal the funds sent.
This RSKIP also gives an alternate method for Bitcoin wallets to obtain RSK federation address: scanning the Bitcoin blockchain looking for migration transactions. This ensures that the wallet has the last address without the need for scanning the RSK blockchain.

# **Copyright**

Copyright and related rights waived via [CC0](https://creativecommons.org/publicdomain/zero/1.0/).,

 
